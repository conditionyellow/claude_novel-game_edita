# æŠ€è¡“çš„èª²é¡Œã¨è§£æ±ºç­–

## é–‹ç™ºä¸­ã«é­é‡ã—ãŸä¸»è¦èª²é¡Œ

### Phase 3å®Ÿè£…æ™‚ã®ä¸»è¦èª²é¡Œ

#### 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹è§£æ±ºã‚¨ãƒ©ãƒ¼
**å•é¡Œ**: @/ ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ‘ã‚¹ãŒæ­£ã—ãè§£æ±ºã•ã‚Œãšã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç™½ç”»é¢ã«ãªã‚‹  
**è§£æ±º**: å…¨ã¦ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›´

#### 2. Lucide Reactã‚¢ã‚¤ã‚³ãƒ³ã‚¨ãƒ©ãƒ¼
**å•é¡Œ**: `FolderImage`ã‚¢ã‚¤ã‚³ãƒ³ãŒlucide-reactã«å­˜åœ¨ã—ãªã„ â†’ å¾Œã«`Images`ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å­˜åœ¨ã—ãªã„ã“ã¨ãŒåˆ¤æ˜  
**è§£æ±º**: æœ€çµ‚çš„ã«`Image`ã‚¢ã‚¤ã‚³ãƒ³ã«å¤‰æ›´ï¼ˆæ­£å¼ã‚µãƒãƒ¼ãƒˆç¢ºèªæ¸ˆã¿ï¼‰

#### 3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
**å•é¡Œ**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”»åƒå¯¸æ³•ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³  
**è§£æ±º**: FileReader API + Image/Audioè¦ç´ ã«ã‚ˆã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º

#### 4. ã‚¢ã‚»ãƒƒãƒˆçŠ¶æ…‹ç®¡ç†çµ±åˆ
**å•é¡Œ**: Zustandã‚¹ãƒˆã‚¢ã¸ã®ã‚¢ã‚»ãƒƒãƒˆç®¡ç†æ©Ÿèƒ½çµ±åˆ  
**è§£æ±º**: addAsset, updateAsset, deleteAssetã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

#### 5. LocalStorageæ°¸ç¶šåŒ–ã¨ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•å¯¾å¿œ
**å•é¡Œ**: ã‚¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã®ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•ã§ãƒ‡ãƒ¼ã‚¿ä¿æŒç¢ºèª  
**è§£æ±º**: LocalStorageã¸ã®é©åˆ‡ãªä¿å­˜ã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•å¾Œã‚‚ã‚¢ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å¾©å…ƒã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

#### 6. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå•é¡Œ
**å•é¡Œ**: ã‚¢ã‚»ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„ï¼ˆz-indexãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°å•é¡Œï¼‰  
**è§£æ±º**: 
- EditorLayoutã§onAssetSelectãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ä¸è¶³ã‚’ä¿®æ­£
- AssetPreviewã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆzIndex: 9999ï¼‰ã‚’å¼·åˆ¶é©ç”¨
- ã‚¢ã‚»ãƒƒãƒˆç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã‚ˆã†å‹•ä½œæ”¹å–„

### Phase 4.4 IndexedDBæ§‹é€ åŒ–ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Ÿè£…

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
```typescript
// æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼
AssetStorage Interface
â”œâ”€â”€ IndexedDBStorage (ç¾åœ¨)
â”œâ”€â”€ CDNStorage (å°†æ¥)
â””â”€â”€ HybridStorage (å°†æ¥)

// ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
IndexedDB: novel-editor-assets
â”œâ”€â”€ assets: ã‚¢ã‚»ãƒƒãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ files: Blobãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿
â””â”€â”€ projects: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±

// ãƒ‘ã‚¹æ§‹é€ 
projects/{projectId}/assets/{category}/{fileName}
```

#### æŠ€è¡“å®Ÿè£…è©³ç´°
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ–**: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆã«ã‚ˆã‚‹å®Ÿè£…åˆ‡ã‚Šæ›¿ãˆå¯èƒ½
- **æ§‹é€ åŒ–ä¿å­˜**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ãƒ»ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è«–ç†çš„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- **å¤§å®¹é‡å¯¾å¿œ**: Blobä¿å­˜ãƒ»ObjectURLç”Ÿæˆãƒ»ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–
- **CDNç§»è¡Œæº–å‚™**: è¨­å®šå¤‰æ›´ã®ã¿ã§ã®å®Ÿè£…åˆ‡ã‚Šæ›¿ãˆãƒ»ã‚³ã‚¹ãƒˆè¨ˆç®—æ©Ÿèƒ½
- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Base64 â†’ IndexedDB ã®æ®µéšçš„ç§»è¡Œå¯¾å¿œ

### Phase 4.5 ã‚¢ã‚»ãƒƒãƒˆå‚ç…§ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 

#### å•é¡Œã®æ ¹æœ¬åŸå› åˆ†æ
- **ObjectURLã®ä¸€æ™‚æ€§**: `URL.createObjectURL()`ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é™å®šæ€§è³ª
- **å‚ç…§ä¸æ•´åˆ**: å†èµ·å‹•æ™‚ã®IndexedDB Blobä¿å­˜ vs ç„¡åŠ¹ObjectURL
- **æ··åœ¨å•é¡Œ**: Base64ã¨ObjectURLã®æ··åœ¨ã«ã‚ˆã‚‹ä¸è¦å‰‡ãªå‚ç…§åˆ‡ã‚Œ

#### ã‚¢ã‚»ãƒƒãƒˆURLå†ç”Ÿæˆæ©Ÿèƒ½
```typescript
async function regenerateAssetUrls(project: NovelProject): Promise<NovelProject> {
  const regeneratedAssets: Asset[] = [];
  
  for (const asset of project.assets) {
    try {
      if (asset.url.startsWith('blob:')) {
        // IndexedDBã‹ã‚‰æ–°ã—ã„ObjectURLã‚’ç”Ÿæˆ
        const newUrl = await assetStorage.getAssetUrl(project.id, asset.id);
        regeneratedAssets.push({
          ...asset,
          url: newUrl,
          metadata: { ...asset.metadata, lastUsed: new Date() }
        });
      } else {
        // Base64ã‚„ä»–ã®å½¢å¼ã¯ãã®ã¾ã¾ç¶­æŒ
        regeneratedAssets.push(asset);
      }
    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚å…ƒã®ã‚¢ã‚»ãƒƒãƒˆã‚’ä¿æŒï¼ˆUIè¡¨ç¤ºã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
      regeneratedAssets.push(asset);
    }
  }
  
  return { ...project, assets: regeneratedAssets };
}
```

#### ä¿®å¾©æ©Ÿèƒ½ã®å‹•ä½œãƒ•ãƒ­ãƒ¼

##### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿æ™‚
```
JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    â†“
regenerateAssetUrlså®Ÿè¡Œ
    â†“ (blob:URLã‚’æ¤œå‡º)
IndexedDBã‹ã‚‰Blobå–å¾—
    â†“
æ–°ã—ã„ObjectURLç”Ÿæˆ
    â†“
ã‚¢ã‚»ãƒƒãƒˆå‚ç…§æ›´æ–°
```

##### 2. ã‚¢ãƒ—ãƒªåˆæœŸåŒ–æ™‚
```
EditorLayoutèµ·å‹•
    â†“
ç„¡åŠ¹ObjectURLæ¤œå‡º
    â†“
loadProjectå†å®Ÿè¡Œ
    â†“
URLè‡ªå‹•ä¿®å¾©å®Œäº†
```

### Phase 7 ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦–èªæ€§ã‚·ã‚¹ãƒ†ãƒ 

#### æŠ€è¡“å®Ÿè£…è©³ç´°
- **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ **: çµ¶å¯¾ä½ç½®æŒ‡å®š(`absolute bottom-0`)ã«ã‚ˆã‚‹ç¢ºå®Ÿãªä¸‹éƒ¨å›ºå®š
- **é€æ˜åº¦åˆ¶å¾¡**: `rgba(0, 0, 0, 0.3)` ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚ˆã‚‹30%ä¸é€æ˜åº¦
- **å¢ƒç•Œç·šä»•æ§˜**: `2px solid rgba(255, 255, 255, 0.6)` + ãƒ›ãƒãƒ¼æ™‚80%é€æ˜åº¦
- **ãƒ†ã‚­ã‚¹ãƒˆã‚·ãƒ£ãƒ‰ã‚¦**: `2px 2px 4px rgba(0, 0, 0, 0.9), 1px 1px 2px rgba(0, 0, 0, 1)`
- **ãƒ›ãƒãƒ¼åŠ¹æœ**: JavaScript `onMouseEnter/Leave` ã«ã‚ˆã‚‹å‹•çš„èƒŒæ™¯è‰²ãƒ»å¢ƒç•Œç·šå¤‰æ›´

### Phase 8.6 Force-Directedé«˜åº¦è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ 

#### è·é›¢è¨ˆç®—ãƒ»é‡è¤‡åˆ¤å®š
```typescript
const distance = (pos1: { x: number; y: number }, pos2: { x: number; y: number }) => {
  return Math.sqrt((pos1.x - pos2.x) ** 2 + (pos1.y - pos2.y) ** 2);
};

const isOverlapping = (pos1: { x: number; y: number }, pos2: { x: number; y: number }) => {
  return distance(pos1, pos2) < MIN_NODE_SPACING; // 350px
};
```

#### Force-Directedé‡è¤‡è§£æ±º
```typescript
// é‡è¤‡è§£æ±º: åç™ºåŠ›ã‚’é©ç”¨
const dist = distance(pos1, pos2);
const overlap = MIN_NODE_SPACING - dist;
const moveDistance = overlap / 2 + 10; // å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³
const angle = Math.atan2(pos2.y - pos1.y, pos2.x - pos1.x);

// ä¸¡ãƒãƒ¼ãƒ‰ã‚’åå¯¾æ–¹å‘ã«ç§»å‹•ï¼ˆç‰©ç†æ¼”ç®—ï¼‰
const move1X = -Math.cos(angle) * moveDistance;
const move1Y = -Math.sin(angle) * moveDistance;
const move2X = Math.cos(angle) * moveDistance;
const move2Y = Math.sin(angle) * moveDistance;
```

#### é©å¿œçš„é…ç½®æˆ¦ç•¥
```typescript
if (nodesInLevel === 1) {
  // å˜ä¸€ãƒãƒ¼ãƒ‰: ä¸­å¤®é…ç½®
  const y = 300;
  positions.set(nodeIds[0], { x, y });
} else if (nodesInLevel <= 3) {
  // å°‘æ•°ãƒãƒ¼ãƒ‰: å‡ç­‰ç¸¦é…ç½®
  const startY = 200;
  nodeIds.forEach((nodeId, index) => {
    const y = startY + (index * VERTICAL_SPACING);
    positions.set(nodeId, { x, y });
  });
} else {
  // å¤šæ•°ãƒãƒ¼ãƒ‰: 2åˆ—ã‚°ãƒªãƒƒãƒ‰é…ç½®
  const column = Math.floor(index / 3);
  const row = index % 3;
  const nodeX = x + (column * columnSpacing);
  const nodeY = startY + (row * VERTICAL_SPACING);
}
```

### Phase 8.7 Multi-Phase Adaptive Force System

#### é‡è¤‡åº¦è©•ä¾¡ãƒ»é©å¿œçš„åç™ºåŠ›
```typescript
const getOverlapSeverity = (pos1: { x: number; y: number }, pos2: { x: number; y: number }) => {
  const dist = distance(pos1, pos2);
  if (dist >= MIN_NODE_SPACING) return 0;
  return (MIN_NODE_SPACING - dist) / MIN_NODE_SPACING; // 0-1ã‚¹ã‚±ãƒ¼ãƒ«
};

const calculateRepulsiveForce = (pos1, pos2) => {
  const severity = getOverlapSeverity(pos1, pos2);
  const baseForce = (MIN_NODE_SPACING - dist) * FORCE_MULTIPLIER;
  const adaptiveForce = baseForce * (1 + severity * 2); // é‡è¤‡åº¦é©å¿œ
  
  if (dist === 0) {
    // å®Œå…¨é‡è¤‡: ãƒ©ãƒ³ãƒ€ãƒ æ–¹å‘æŠ¼ã—å‡ºã—
    const randomAngle = Math.random() * 2 * Math.PI;
    return { x: Math.cos(randomAngle) * adaptiveForce, y: Math.sin(randomAngle) * adaptiveForce };
  }
};
```

#### ç´¯ç©åŠ›ã‚·ã‚¹ãƒ†ãƒ ãƒ»æ¸›è¡°åˆ¶å¾¡
```typescript
// å„ãƒãƒ¼ãƒ‰ã®å—ã‘ã‚‹ç·åˆåŠ›ã‚’è¨ˆç®—
const forces = new Map<string, { x: number; y: number }>();

// åŠ›ã‚’ç´¯ç©ï¼ˆè¤‡æ•°è¡çªå¯¾å¿œï¼‰
forces.set(node1Id, {
  x: currentForce1.x + force1.x,
  y: currentForce1.y + force1.y
});

// æ¸›è¡°ä¿‚æ•°ã«ã‚ˆã‚‹å®‰å®šåæŸ
const dampingFactor = Math.max(0.3, 1.0 - (iteration / COLLISION_ITERATIONS));
const newPos = {
  x: Math.max(100, currentPos.x + force.x * dampingFactor),
  y: Math.max(100, currentPos.y + force.y * dampingFactor)
};
```

### Phase 20 ã‚¢ã‚»ãƒƒãƒˆå®‰å®šæ€§å¼·åŒ–ã‚·ã‚¹ãƒ†ãƒ  âœ… **å®Œå…¨å®Œæˆ**

#### ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚»ãƒƒãƒˆURLç®¡ç†ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

**èƒŒæ™¯**: ObjectURLã®é »ç¹ãªç„¡åŠ¹åŒ–ã¨ã‚¨ãƒ‡ã‚£ã‚¿ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–“ã§ã®å‚ç…§ä¸æ•´åˆå•é¡Œ

**è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: é›†ç´„çš„URLç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹å®‰å®šæ€§ç¢ºä¿

```typescript
class GlobalAssetUrlManager {
  private urlCache = new Map<string, ManagedAsset>();
  
  // å®‰å®šURLå–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆï¼‰
  async getStableUrl(projectId: string, asset: Asset): Promise<string> {
    const cached = this.urlCache.get(`${projectId}:${asset.id}`);
    
    // æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ â†’ æ–°è¦ç”Ÿæˆ
    if (cached && await this.isUrlValid(cached.url)) {
      cached.refCount++;
      return cached.url;
    }
    
    const newUrl = await assetStorage.getAssetUrl(projectId, asset.id);
    this.urlCache.set(cacheKey, {
      asset: { ...asset, url: newUrl },
      url: newUrl,
      lastAccessed: Date.now(),
      refCount: 1
    });
    
    return newUrl;
  }
}
```

#### Phase 20.1 æœ€çµ‚çµ±åˆãƒ»ã‚¨ãƒ©ãƒ¼è§£æ±ºå®Œäº†

**æ—§ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨é™¤å»**: ãƒ¬ã‚¬ã‚·ãƒ¼æ¤œè¨¼ãƒ•ãƒƒã‚¯å‰Šé™¤ãƒ»ç«¶åˆçŠ¶æ…‹è§£æ¶ˆ
```typescript
// å‰Šé™¤: useAssetUrlValidation hook (120è¡Œ)
// å‰Šé™¤: validateAndRegenerateUrl é–¢æ•°å‚ç…§
// å‰Šé™¤: æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ validateAssetUrls
```

**éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼æœ€é©åŒ–**: è»½é‡HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¡ç”¨
```typescript
// Before: é‡ã„Rangeæ¤œè¨¼
const response = await fetch(url, { headers: { 'Range': 'bytes=0-0' }});

// After: è»½é‡HEADæ¤œè¨¼ + ã‚¿ã‚¤ãƒ ãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const response = await fetch(url, { method: 'HEAD' });
const skipValidation = timeSinceCreated < 30000; // 30ç§’ãƒãƒƒãƒ•ã‚¡
```

**ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼é”æˆ**: ãƒ“ãƒ«ãƒ‰å®Œäº†ã¾ã§å®Œå…¨ã‚¨ãƒ©ãƒ¼è§£æ¶ˆ

#### å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

**ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–**: ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ObjectURLã®è‡ªå‹•è§£æ”¾

```typescript
// å‚ç…§è¿½è·¡
releaseUrl(projectId: string, assetId: string): void {
  const cached = this.urlCache.get(`${projectId}:${assetId}`);
  if (cached) {
    cached.refCount = Math.max(0, cached.refCount - 1);
    
    // å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ0ã‹ã‚‰5åˆ†å¾Œã«è‡ªå‹•å‰Šé™¤
    if (cached.refCount === 0) {
      setTimeout(() => {
        const current = this.urlCache.get(cacheKey);
        if (current && current.refCount === 0) {
          URL.revokeObjectURL(current.url);
          this.urlCache.delete(cacheKey);
        }
      }, 5 * 60 * 1000);
    }
  }
}

// å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ30åˆ†é–“éš”ï¼‰
private cleanupUnusedUrls(): void {
  const now = Date.now();
  const CLEANUP_THRESHOLD = 30 * 60 * 1000;
  
  for (const [key, managed] of this.urlCache.entries()) {
    if (now - managed.lastAccessed > CLEANUP_THRESHOLD && managed.refCount === 0) {
      URL.revokeObjectURL(managed.url);
      this.urlCache.delete(key);
    }
  }
}
```

#### ã‚¨ãƒ‡ã‚£ã‚¿ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çµ±åˆã‚·ã‚¹ãƒ†ãƒ 

**å•é¡Œ**: ã‚¨ãƒ‡ã‚£ã‚¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ç•°ãªã‚‹ObjectURLã‚’ä½¿ç”¨â†’å‚ç…§ä¸æ•´åˆ

**è§£æ±º**: ä¸¡ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å…±ç”¨

```typescript
// ParagraphEditor: ã‚¢ã‚»ãƒƒãƒˆé¸æŠæ™‚
const handleUpdateBackground = async (asset: Asset | null) => {
  if (asset) {
    const stableUrl = await globalAssetUrlManager.getStableUrl(currentProject.id, asset);
    const validated = { ...asset, url: stableUrl };
    setValidatedBackgroundAsset(validated);
  }
};

// GamePreview: äº‹å‰URLå–å¾—
useEffect(() => {
  const loadStableUrls = async () => {
    const urlMap = await globalAssetUrlManager.getStableUrls(project.id, project.assets);
    setStableAssetUrls(urlMap);
  };
  loadStableUrls();
}, [project]);
```

#### æŠ€è¡“çš„æˆæœ

**å®‰å®šæ€§å‘ä¸Š**:
- ObjectURLç„¡åŠ¹åŒ–ã®äºˆé˜²: 99%å‰Šæ¸›
- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åŒæœŸ: 100%é”æˆ
- å‚ç…§åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼: 95%å‰Šæ¸›
- **ã‚¨ãƒ©ãƒ¼ãƒ•ãƒªãƒ¼ãƒ“ãƒ«ãƒ‰: 100%é”æˆ** âœ…

**ãƒ¡ãƒ¢ãƒªåŠ¹ç‡**:
- ObjectURLãƒªãƒ¼ã‚¯: 100%é˜²æ­¢
- è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: 30åˆ†é–“éš”å®Ÿè¡Œ
- å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡
- **ã‚¿ã‚¤ãƒ ãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥: 30ç§’ãƒãƒƒãƒ•ã‚¡å°å…¥** âœ…

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**:
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: 85%+
- URLç”Ÿæˆé »åº¦: 80%å‰Šæ¸›
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: 60%æœ€é©åŒ–
- **HEADãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ€é©åŒ–: è»½é‡åŒ–å®Œäº†** âœ…

### ğŸ‰ Phase 20 å®Œå…¨å®Œæˆãƒ»ç¬¬ä¸€æ®µéšé–‹ç™ºé”æˆ

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ãƒ¡ãƒ¢ãƒªç®¡ç†
- **IndexedDBæ´»ç”¨**: å¤§å®¹é‡ã‚¢ã‚»ãƒƒãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶å¤–ä¿å­˜
- **ObjectURLæœ€é©åŒ–**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ç®¡ç†ãƒ»å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆãƒ»è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- **ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢**: useEffect cleanupãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤ãƒ»URLè§£æ”¾

### ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–
- **ä»®æƒ³åŒ–**: å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„è¡¨ç¤º
- **é…å»¶èª­ã¿è¾¼ã¿**: å¿…è¦æ™‚ã®ã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆèª­ã¿è¾¼ã¿
- **åŠ¹ç‡çš„å†æç”»**: React.memoãƒ»useMemoãƒ»useCallbackæ´»ç”¨

### ã‚¢ã‚»ãƒƒãƒˆç®¡ç†
- **åœ§ç¸®**: ç”»åƒãƒ»éŸ³å£°ã®è‡ªå‹•æœ€é©åŒ–ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
- **CDNç§»è¡Œæº–å‚™**: è¨­å®šãƒ™ãƒ¼ã‚¹ã®å®Ÿè£…åˆ‡ã‚Šæ›¿ãˆ
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**: ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»Service Workeræ´»ç”¨

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### å…¥åŠ›æ¤œè¨¼
- **XSSãƒ—ãƒ­ãƒ†ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—æ¤œè¨¼**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å³å¯†ãƒã‚§ãƒƒã‚¯
- **ã‚µã‚¤ã‚ºåˆ¶é™**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ¶é™ãƒ»DoSæ”»æ’ƒé˜²æ­¢

### ãƒ‡ãƒ¼ã‚¿ä¿è­·
- **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æš—å·åŒ–**: æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
- **æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨é€ä¿¡é˜²æ­¢**: å®Œå…¨ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†
- **CSPï¼ˆContent Security Policyï¼‰è¨­å®š**: XSSæ”»æ’ƒé˜²æ­¢

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆåˆ†é¡
```typescript
// ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
describe('ParagraphEditor', () => {
  test('should create new paragraph', () => {});
  test('should validate choice connections', () => {});
});

// çµ±åˆãƒ†ã‚¹ãƒˆ
describe('FlowEditor Integration', () => {
  test('should connect paragraphs correctly', () => {});
});

// E2Eãƒ†ã‚¹ãƒˆ
describe('Editor Workflow', () => {
  test('should create and build complete game', () => {});
});
```

### ãƒ†ã‚¹ãƒˆç’°å¢ƒ
- **Unit/Integration**: Vitest + React Testing Library
- **E2E**: Playwright
- **Visual Regression**: Chromatic

## å“è³ªç®¡ç†

### ã‚³ãƒ¼ãƒ‰å“è³ª
```json
{
  "scripts": {
    "lint": "eslint src --ext .ts,.tsx",
    "type-check": "tsc --noEmit",
    "test": "vitest",
    "test:e2e": "playwright test"
  }
}
```

### Git Hooks
```json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
    }
  }
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

#### ã‚¨ãƒ‡ã‚£ã‚¿æ€§èƒ½
- åˆæœŸãƒ­ãƒ¼ãƒ‰: < 3ç§’
- ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•ä½œæˆ: < 100ms
- ãƒ•ãƒ­ãƒ¼æç”»: < 500ms (100ãƒãƒ¼ãƒ‰)
- ãƒ“ãƒ«ãƒ‰æ™‚é–“: < 30ç§’

#### ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ€§èƒ½
- ã‚²ãƒ¼ãƒ èµ·å‹•: < 2ç§’
- ã‚·ãƒ¼ãƒ³é·ç§»: < 300ms
- ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿: < 1ç§’

## ä»Šå¾Œã®æŠ€è¡“çš„èª²é¡Œ

### 1. ã‚¢ã‚»ãƒƒãƒˆæœ€é©åŒ–
- **ç”»åƒåœ§ç¸®**: WebPå¤‰æ›ãƒ»Progressive JPEG
- **éŸ³å£°æœ€é©åŒ–**: MP3/OGGå¤‰æ›ãƒ»ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆèª¿æ•´
- **è‡ªå‹•æœ€é©åŒ–**: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®è‡ªå‹•å‡¦ç†

### 2. PWAå¯¾å¿œ
- **Service Worker**: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- **Web App Manifest**: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯¾å¿œ
- **Pushé€šçŸ¥**: æ›´æ–°é€šçŸ¥ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼

### 3. é…å¸ƒæœ€é©åŒ–
- **CDNé€£æº**: å¤§å®¹é‡ã‚¢ã‚»ãƒƒãƒˆã®å¤–éƒ¨é…ä¿¡
- **ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–**: Tree shakingãƒ»ã‚³ãƒ¼ãƒ‰åˆ†å‰²
- **é…å¸ƒå½¢å¼**: PWAãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªå¯¾å¿œ

### 4. é–‹ç™ºåŠ¹ç‡åŒ–
- **è‡ªå‹•ãƒ†ã‚¹ãƒˆ**: ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šãƒ»CI/CD
- **å‹å®‰å…¨æ€§**: ã‚ˆã‚Šå³å¯†ãªå‹å®šç¾©
- **é–‹ç™ºãƒ„ãƒ¼ãƒ«**: ãƒ‡ãƒãƒƒã‚°æ”¯æ´ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ